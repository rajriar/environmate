<!--
    Author: Rajdeep Riar
    Purpose/Function: includes nav bar, along wiht cookie script for user log in
    Date: 8/8/2019
 -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<!-- Google Analytics -->
<script>
    (function (i, s, o, g, r, a, m) {
    i['GoogleAnalyticsObject'] = r; i[r] = i[r] || function () {
        (i[r].q = i[r].q || []).push(arguments)
    }, i[r].l = 1 * new Date(); a = s.createElement(o),
        m = s.getElementsByTagName(o)[0]; a.async = 1; a.src = g; m.parentNode.insertBefore(a, m)
    })(window, document, 'script', 'https://www.google-analytics.com/analytics.js', 'ga');

ga('create', 'UA-145593934-1', 'auto');
    ga('send', 'pageview');
</script>

<!-- End Google Analytics -->

<script src="https://code.jquery.com/jquery-3.4.1.js" integrity="sha256-WpOohJOqMqqyKL9FccASB9O0KwACQJpFTUBLTYOVvVU="
    crossorigin="anonymous"></script>  
<p class="text-muted bg-dark mx-0 my-0" style="text-align: center;"><small>SFSU Software Engineering Project CSC
        648-848, Summer 2019. For Demonstration Only</small></p>
<% include modals.ejs%>
<nav class="navbar navbar-fixed-top navbar-expand-lg navbar-dark bg-dark">
    <a class="navbar-brand mx-1 my-1" href="/">EnvironMate</a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent"
        aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse mx-0 my-1" id="navbarSupportedContent">
        <ul class="navbar-nav ">
            <li class="nav-item">
                <a class="nav-link about-nav" id="about-nav" href="/about">About</a>
            </li>
        </ul>
        <div name="searchbar" class="searchbar">
            <form name="search" action="/results" id="search" class="form-inline my-1 mx-4 search">

                    <input name="search_text" type="text" class="form-control mr-sm-2 search_text" aria-label="Text input with dropdown button"
                        placeholder="Search" maxlength="50" id="search_text">
                    <div class="input-group-append">
                        <input class="btn btn-outline-success my-2 my-sm-0" type="submit" value="Search" 
                                onclick="captureSearch(document.getElementById('search_text').value)">
                    </div>

            </form>
        </div>
         <ul class="navbar-nav mx-1 my-1">
            <div class="nav-item post-nav">
                <a href="/incidents/report"><button class="btn btn-outline-danger btn-md post-button" id="post-button">Post Incident</button></a>
                <!-- <a class="nav-link post-nav" href="/incidents/report">Post Incident</a> -->
            </div>
        </ul>

    </div>
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
       
        <div id="authContainer">
            <div class="pt-1 welcomeMsgCont" id="welcomeMsgCont">
                <span id="welcomeMsg" style="color: white; font-size: 13px; text-align: center;"></span>
            </div>
            <div class="px-3 signoutButton" id="signoutButton">
                <form action="/signout" method="post">
                    <button type="submit" id="signout" class="btn btn-outline-primary btn-md">
                        Log Out
                    </button>
                </form>
            </div>
        </div>
            <ul class="navbar-nav ml-auto">
            <div id="unauthContainer">
                <ul class="navbar-nav ml-auto">
                <!-- Button trigger for sign up -->
                <li class="nav-item signup-nav">
                    <button type="button" class="btn btn-outline-primary btn-md signup-nav-button" id="signup-nav-button" data-toggle="modal"
                        data-target="#signupPopup">
                        Sign Up
                    </button>
                </li>
                    <!-- Button trigger for log in -->
                    <li class="nav-item post-nav mx-1 my-1">
                        <button type="button" id="loginPopupButton" class="btn btn-outline-primary btn-md login-nav" data-toggle="modal" data-target="#loginPopup" value="signout">

                        Log In
                    </button>
                </li>
            </ul>
        </div>
    </div>
</nav>

<script>
    // To capture the search value from searchbar
    var captureSearch = function(searchValue){
        if(searchValue != null){
            console.log(searchValue);
            sessionStorage.setItem('search', searchValue)
        }
    }
    // To update the search bar with value captured
    var updateSearch = function(){
        var search = sessionStorage.getItem('search');
        console.log(search);
        //Display the search bar with the value only in results page and incident detail page
        if( window.location.pathname == "/results" || window.location.pathname.substr(0,15)== "/incidents/view" ){
            document.getElementById('search_text').value = search;
        }
        // If user navigates to home reset the search value
        else if(window.location.pathname == "/"){
            captureSearch("");
        }
        
    }
    
    //calls to update search box
    document.onchange = updateSearch();


    // get cookie from URI encoded cookie obj.
    // @param cname is the name of a cookie (ie. 'user')
    // @return string representation of cookie object that was set.
    var getCookie = function (cname) {
        var name = cname + "=";
        var decodedCookie = decodeURIComponent(document.cookie);
        var cookieJson = [];
        for (let i = 0; i < decodedCookie.length; i++) {
            if (decodedCookie[i] === '{') {
                cookieJson = decodedCookie.substring(i);
                return cookieJson;

            }
        }
        return null;
    }

    // function that update auth-related nav components/buttons
    var updateAuthButtons = () =>{
        var cookie = getCookie('user');
        if (!cookie) {
            //hide authContainer
            $('#authContainer').hide();
            //show authContainer
            $('#unauthContainer').show();
            // loginUnsuccessful(); undefined function?
        } else {
            let parsed = JSON.parse(cookie);
            $(document).ready(function () {
                //hide logged in controls until after cookie check
                $('#authContainer').show();
            });
            //set welcome message
            let welcomeMessage = "Welcome, " + parsed.firstName;
            $('#welcomeMsg').text(welcomeMessage);
            //show authContainer
            $('#authContainer').show();
            $('#unauthContainer').hide();
            // console.log(parsed.firstName);
        }
    }
    // each reloads update buttons
    updateAuthButtons();
    
</script>